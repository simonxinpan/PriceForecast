<script>
    // --- 1. 配置区域 ---
    const apiKey = 'ZYpXufkAUGUmzHLH5F4WeFFhStiaL7xu'; // 替换为您自己的FMP API Key
    const stockTicker = 'AAPL'; // 我们要分析的股票代码

    // --- 2. 核心数据获取与处理函数 ---
    async function fetchAndRenderForecast() {
        const container = document.getElementById('stock-analysis-container');
        container.innerHTML = '<div class="card"><p>正在加载分析师预报数据...</p></div>';

        try {
            const [quoteResponse, estimatesResponse] = await Promise.all([
                fetch(`https://financialmodelingprep.com/api/v3/quote-short/${stockTicker}?apikey=${apiKey}`),
                fetch(`https://financialmodelingprep.com/api/v3/analyst-estimates/${stockTicker}?apikey=${apiKey}`)
            ]);

            if (!quoteResponse.ok || !estimatesResponse.ok) {
                throw new Error('API网络响应错误');
            }

            const quoteData = await quoteResponse.json();
            const estimatesData = await estimatesResponse.json();

            console.log('获取到当前股价数据:', quoteData);
            console.log('获取到分析师预报数据:', estimatesData);

            if (!quoteData || quoteData.length === 0 || !estimatesData || estimatesData.length === 0) {
                throw new Error('未能获取到有效的股票数据或分析师预报。');
            }

            const currentPrice = quoteData[0].price;
            const latestForecast = estimatesData[0];
            
            container.innerHTML = createStockHTML(currentPrice, latestForecast);
            updateDashboard(currentPrice, latestForecast);

        } catch (error) {
            console.error('渲染数据时发生严重错误:', error);
            container.innerHTML = `<div class="card"><p style="color:red;">数据加载失败！错误: ${error.message}</p></div>`;
        }
    }

    // --- 3. 动态生成HTML的辅助函数 ---
    function createStockHTML(currentPrice, forecast) {
        const upside = ((forecast.estimatedPriceAvg / currentPrice) - 1) * 100;
        const isPositive = upside >= 0;
        return `
            <header class="stock-header">
                <div>
                    <div class="symbol">${forecast.symbol}</div>
                    <div class="name">苹果公司</div>
                </div>
            </header>
            <div class="card">
                <div class="timeframe-selector">
                    <button class="timeframe-btn active">未来12个月</button>
                </div>
                <div class="gauge-display">
                    <div class="gauge-side-label">
                        <span class="value current">$${currentPrice.toFixed(2)}</span>
                        <span class="label">当前股价</span>
                    </div>
                    <div class="gauge-container">
                        <div class="gauge-chart" id="gaugeChart"></div>
                        <div class="zero-line"></div>
                        <div class="potential-summary">
                            <div class="value ${isPositive ? 'positive' : 'negative'}">${isPositive ? '▲' : '▼'} ${Math.abs(upside).toFixed(1)}%</div>
                            <div class="label">潜在空间</div>
                        </div>
                    </div>
                    <div class="gauge-side-label">
                        <span class="value ${isPositive ? 'positive' : 'negative'}">$${forecast.estimatedPriceAvg.toFixed(2)}</span>
                        <span class="label">平均目标价</span>
                    </div>
                </div>
            </div>
            <div class="card">
                 <h2>分析师共识</h2>
                <div class="consensus-grid">
                    <div class="consensus-stats">
                        <div class="stat-item"><div class="label">评级分析师</div><div class="value">${forecast.analystsCount} 位</div></div>
                        <div class="stat-item"><div class="label">平均目标价</div><div class="value">$${forecast.estimatedPriceAvg.toFixed(2)}</div></div>
                        <div class="stat-item"><div class="label">目标价范围</div><div class="value">$${forecast.estimatedPriceLow} - $${forecast.estimatedPriceHigh}</div></div>
                    </div>
                    <div class="rating-chart" id="ratingChart"></div>
                </div>
            </div>
        `;
    }

    // --- 4. 更新图表的函数 ---
    function updateDashboard(currentPrice, forecast) {
        const upside = ((forecast.estimatedPriceAvg / currentPrice) - 1) * 100;
        const isPositive = upside >= 0;
        const absoluteMarketMax = 60.0; // 模拟的市场最大潜力值
        const fillPercent = Math.min(Math.abs(upside) / absoluteMarketMax, 1);
        const degree = fillPercent * 90;
        
        let gradient;
        if (isPositive) {
            gradient = `conic-gradient(from 180deg at 50% 100%, #e9ecef 0deg 90deg, #27ae60 90deg ${90 + degree}deg, #e9ecef ${90 + degree}deg 180deg)`;
        } else {
            gradient = `conic-gradient(from 180deg at 50% 100%, #e9ecef 0deg ${90 - degree}deg, #e74c3c ${90 - degree}deg 90deg, #e9ecef 90deg 180deg)`;
        }
        document.getElementById('gaugeChart').style.background = gradient;
        
        const ratingChart = document.getElementById('ratingChart');
        const totalRatings = forecast.buy + forecast.hold + forecast.sell;
        ratingChart.innerHTML = `
            <div class="bar-wrapper"><div class="bar-label">买入</div><div class="bar bar-buy" style="width:${(forecast.buy/totalRatings)*100}%">${forecast.buy}</div></div>
            <div class="bar-wrapper"><div class="bar-label">持有</div><div class="bar bar-hold" style="width:${(forecast.hold/totalRatings)*100}%">${forecast.hold}</div></div>
            <div class="bar-wrapper"><div class="bar-label">卖出</div><div class="bar bar-sell" style="width:${(forecast.sell/totalRatings)*100}%">${forecast.sell}</div></div>
        `;
    }

    // --- 5. 页面加载完成后执行 ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('currentDate').textContent = `截至 ${new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' })}`;
        fetchAndRenderForecast();
    });
</script>
